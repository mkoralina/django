<!DOCTYPE html>
<html lang="en" manifest="offline/cache.manifest">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!--ajax-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">


    {% load staticfiles %}
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" media="screen">
    <style type="text/css">
    /*calosc stylow*/

    .btn-room {
        width: 7em;
    }

    td {
        padding: 10px;
    }

    </style>

    <title>Reserve your room now!</title>

    {% load staticfiles %}
    <script src="{% static 'jquery.min.js' %}"></script>
    {% load staticfiles %}
    <script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>


</head>

<body>


{% if messages %}
    <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    <hr><br>
{% endif %}


<!-- modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Available dates</h4>
      </div>
      <div id="modalContent" class="modal-body">
        This content will be loaded on the choice of the user.
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    </div>
  </div>
</div>


<div id='loadingmessage' style='display:none'>
  <img src="{% static 'ajax-loader.gif' %}"/>
</div>

<div class="main">

  <table align="center">
        <tr>
        <td>
        Rooms with their capacities : <br><br>
            <div id="list">
                This content will be loaded when AJAX has fetched the database
            </div>

          <div class="pagination">
            <span class="step-links">
                {% if queryset.has_previous %}
                    <a href="?page={{ queryset.previous_page_number }}">previous</a>
                {% endif %}

                <span class="current">
                    Page {{ queryset.number }} of {{ queryset.paginator.num_pages }}.
                </span>

                {% if queryset.has_next %}
                    <a href="?page={{ queryset.next_page_number }}">next</a>
                {% endif %}
            </span>
          </div>
      </td>
      <td align="right">

        <form action="" id="searcher" method="POST">
            Search
            <input type="text" name="keyword">
            in description or name. <br>
            Capacity from:
            <input type="number" name="min_capacity">
            to:
            <input type="number" name="max_capacity">
            <br><br>

            Required equipment:<br>
            <input type="checkbox" name="projector"> Projector<br>
            <input type="checkbox" name="whiteboard"> Whiteboard<br>
            <input type="checkbox" name="blackboard"> Blackboard<br>
            <input type="checkbox" name="scanner"> Scanner<br>
            <input type="checkbox" name="printer"> Printer<br>

            <input type="button" class="btn btn-large" value="Search" onclick="displayResults(this.form)">
            <br><br><br>
        </form>

        <form action="" id="form_order" method="POST">
        <select name="order" form="form_order" id="select_id" onchange="changeOrder(this.form)">
            <option value="'0'">Choose order of display</option>
            <option value="alph">A-Z</option>
            <option value="alph_inv">Z-A</option>
            <option value="cap">by capacity ascending</option>
            <option value="cap_inv">by capacity descending</option>
        </select><br><br>
        </form>
      </td>
    </tr>
  </table>
</div>

<br><br>


{% if user.is_authenticated %}
    <p>You are logged in as: {{ user.username }}<br>
       <a href="{% url 'a:logout' %}">Log out</a></p>
{% endif %}


<script>

var rooms = [];
var terms = [];
var equip = [];
var boards = [];
var currentRooms = [];
var count = 0;


function getModalContent(id) {
    name = "";
    for (var i = 0; i < rooms.length; i++){
        if (rooms[i].id == id) {
            name += rooms[i].name;
            break;
        }
    }
    data = "";
    data += "Beware: you can reserve terms from one day at a time." +
            "If you open a new date while on a different one" +
            "If you open a new date while on a different one" +
            "you will lose your previous choices." +
            "<h1>" + name + "</h1>" +
            "<div id='chosenCounter'>" +
            "You have chosen " + count + " hour(s) so far<br><br>" +
            "</div>"
    thisTerms = [];
    for (var i = 0; i < rooms.length; i++) {
        if (rooms[i].id == id) {
            for (var j = 0; j < rooms[i].terms.length; j++) {
                thisTerms.push(rooms[i].terms[j]);
            }
            break;
        }
    }
    if (thisTerms.length > 0) {
        //TODO: dokoncz wystwietlanie terminow
        data += "Tutaj wyswietla sie dostepne terminy"
    }
    else {
        data += "There are no terms available.";
    }
    return data;
}


function lookFor(name, items) {
    //TODO: mozna by to bylo zrobic efektywniej..
    tmp = [];
    for (var i = 0; i < items.length; i++){
        added = 0;
        equipment = items[i].equipment;
        console.log(equipment);
        for (var j = 0; j < equipment.length; j++){
            id = equipment[j];
            for (var k = 0; k < equip.length; k++) {
                console.log(equip);
                if (id == equip[k].id && equip[k].type == name) {
                    tmp.push(items[i]);
                    added = 0;
                    break;
                }
            }
            if (added) break;
        }
    }
    items = tmp.slice();
    return items;
}

function lookForBoard(name, items) {
    //TODO: mozna by to bylo zrobic efektywniej..
    tmp = [];
    for (var i = 0; i < items.length; i++){
        added = 0;
        thisBoards = items[i].boards;
        for (var j = 0; j < thisBoards.length; j++){
            id = thisBoards[j];
            for (var k = 0; k < boards.length; k++) {
                if (id == boards[k].id && boards[k].type == name) {
                    tmp.push(items[i]);
                    added = 0;
                    break;
                }
            }
            if (added) break;
        }
    }
    items = tmp.slice();
    return items;
}



function displayResults(form) {
    var items = rooms.slice();
    var tmp = [];
    if (form.keyword.value != "") {
        tmp = [];
        for (var i = 0; i < items.length; i++){
            if (items[i].description.indexOf(form.keyword.value) > -1
                 || items[i].name.indexOf(form.keyword.value) > -1) {
                tmp.push(items[i]);
            }
        }
        items = tmp.slice();
    }
    if (form.min_capacity.value != "") {
        tmp = [];
        for (var i = 0; i < items.length; i++){
            if (items[i].capacity >= form.min_capacity.value) {
                tmp.push(items[i]);
            }
        }
        items = tmp.slice();
    }
    if (form.max_capacity.value != "") {
        tmp = [];
        for (var i = 0; i < items.length; i++){
            if (items[i].capacity <= form.max_capacity.value) {
                tmp.push(items[i]);
            }
        }
        items = tmp.slice();
    }
    if (form.projector.checked)
        items = lookFor('projector', items);
    if (form.whiteboard.checked)
        items = lookForBoard('whiteboard', items);
    if (form.blackboard.checked)
        items = lookForBoard('blackboard', items);
    if (form.scanner.checked)
        items = lookFor('scanner', items);
    if (form.printer.checked)
        items = lookFor('printer', items);

    loadRoomList(items);
}


function changeOrder(form) {
    //TODO: jeszcze nie dziala
    items = currentRooms;
    var order = document.getElementById("select_id").selectedIndex;
    if (order == 1) {//'alph'
        console.log("wszedl do srodka");
        items.sort(function(a,b) {
            if (a.name < b.name)
                return a-b;
            else
                return b-a;
        });
    }
    else if (order == 2) //'alph_inv'
        ;//queryset = queryset.order_by('name').reverse()
    else if (order == 3) //'cap'
        ;//queryset = queryset.order_by('capacity')
    else if (order == 4) //'cap_inv'
        ;//queryset = queryset.order_by('capacity').reverse()

    loadRoomList(items);

}


function Term(id, date, begin, end) {
    this.id = id;
	this.date = date;
	this.begin = begin;
	this.end = end;

	this.toString = function() {
		return this.date + ' ' + this.begin + ' - ' + this.end;
	};

}

function Equipment(id, type, name) {
    this.id = id;
	this.type = type;
	this.name = name;
	
	this.toString = function() {
		return this.type + ": " + this.name;
	}
}

function Board(id, type, name) {
	this.id = id;
    this.type = type;
	this.name = name;

	this.toString = function() {
		return this.type + ": " + this.name;
	}
}

function Room(id, name, capacity, description, terms, equipment, boards) {
	this.id = id;
    this.name = name;
	this.capacity = capacity;
	this.description = description;
	this.terms = terms;
	this.equipment = equipment;
	this.boards = boards;

	this.toString = function() {
		return this.name;
	}
}

function getRooms(url) {
    var parsedData;
    var jqxhr = $.ajax(
        url,
        {
            type:"GET",
            data: {}
        })
    .done(function(data) {
        console.log(url);
        parsedData = JSON.parse(data);
        console.log(parsedData);
        })
    .fail(function() {
        console.log( "error" );
        })
    .always(function() {
        console.log( "complete" );
        for (var i = 0; i < parsedData.length; i++) {
            var item = parsedData[i];
            var r = new Room(item.pk, item.fields.name, item.fields.capacity,
                    item.fields.description, item.fields.terms, item.fields.equipment_items, item.fields.boards);
            rooms.push(r);
        }
        console.log('rooms: ' + rooms);
    });

}

function getTerms(url) {

    var parsedData;
    var jqxhr = $.ajax(
        url,
        {
            type:"GET",
            data: {}
        })
    .done(function(data) {
        console.log(url);
        parsedData = JSON.parse(data);
        console.log(parsedData);
        })
    .fail(function() {
        console.log( "error" );
        })
    .always(function() {
        console.log( "complete" );
        for (var i = 0; i < parsedData.length; i++) {
            var item = parsedData[i];
            var t = new Term(item.pk, item.fields.date, item.fields.begin_time, item.fields.end_time);
            terms.push(t);
        }
        console.log('terms: ' + terms);
    });
}


function getBoards(url) {
    var parsedData;
    var jqxhr = $.ajax(
        url,
        {
            type:"GET",
            data: {}
        })
    .done(function(data) {
        console.log(url);
        parsedData = JSON.parse(data);
        console.log(parsedData);
        })
    .fail(function() {
        console.log( "error" );
        })
    .always(function() {
        console.log( "complete" );
        for (var i = 0; i < parsedData.length; i++) {
            var item = parsedData[i];
            var b = new Board(item.pk, item.fields.type, item.fields.name);
            boards.push(b);
        }
        console.log('boards: ' + boards);
    });
}


function getEquip(url) {
    var parsedData;
    var jqxhr = $.ajax(
        url,
        {
            type:"GET",
            data: {}
        })
    .done(function(data) {
        console.log(url);
        parsedData = JSON.parse(data);
        console.log(parsedData);
        })
    .fail(function() {
        console.log( "error" );
        })
    .always(function() {
        console.log( "complete" );
        for (var i = 0; i < parsedData.length; i++) {
            var item = parsedData[i];
            var e = new Equipment(item.pk, item.fields.type, item.fields.name);
            equip.push(e);
        }
        console.log('equipment: ' + equip);
    });
}

function loadRoomList(items) {
    var list;
    var onPage = 4; // TODO: paginator albo przez tego plug-ina
    var counter = 0;
    list = "<table border='0'>" +
            "<tr><td><b>Room</b></td>" +
                "<td><b>Capacity</b></td>" +
            "</tr>";
    for (var i = 0; i < items.length; i++){
        list += "<tr><td>" +
                "<button id=" + items[i].id + ' class="btn btn-primary btn-lg btn-room" data-toggle="modal" data-target="#myModal">' +
                items[i].name +
                "</button>" +
                "</td>" +
                "<td>" + items[i].capacity + "</td></tr>";
    }
    list += "</table>";
    currentRooms = items.slice();
    $('#list').html(list);
}


$(document).ready(function () {
	console.log("ready");
	$('#loadingmessage').show();
	console.log("ajax will try to fetch database");

    console.log('token dla list: ' + csrftoken);

    //sciaganie i obrobka danych
    getTerms("/a/database/terms");
    getEquip("/a/database/equip");
    getBoards("/a/database/boards");
    getRooms("/a/database/rooms");

    //czekam az skonczy ajaxa
    $(document).ajaxComplete(function() { //uwaga, bo sie zalacza za kazdym razem, kiedy skonczy sie ajax, a wiec
        //zadziala tylko wtedy, gdy tylko w 1. miejscu bede stosowac ajax (czyli tak jak w zalozeniu)
        console.log("ajax completed");
        $('#loadingmessage').hide();

        loadRoomList(rooms);


    })

});

$(".btn-room").click(function(e) {
    console.log("wybrano pokoj");

    e.preventDefault()
    id = $(this).attr('id')

    url = "/a/" + id + "/"

    data = getModalContent(id);

    $("#modalContent").html(data);

});

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

var csrftoken = getCookie('csrftoken');


function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
function sameOrigin(url) {
    // test that a given url is a same-origin URL
    // url could be relative or scheme relative or absolute
    var host = document.location.host; // host + port
    var protocol = document.location.protocol;
    var sr_origin = '//' + host;
    var origin = protocol + sr_origin;
    // Allow absolute or scheme relative URLs to same origin
    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
            // Send the token to same-origin, relative URLs only.
            // Send the token only if the method warrants CSRF protection
            // Using the CSRFToken value acquired earlier
            console.log("A");
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});






$(".btn-group :checkbox").change(function(e) {
    e.preventDefault();
    if (this.checked) {
        count += 1;
    }
    else {
        count -= 1;
    }
    $("#chosenCounter").html("You have chosen " + count + " hour(s) so far <br><br>");
});

$(".panel-heading").on('click',function() {
    $('input[type=checkbox]').each(function(i)
    {
        if (this.checked) {
            $(".btn-group label").eq(i).button('toggle');
        }
    });
});

$(".btn-reserve").click(function(e) {
        e.preventDefault();
        var hours = [];
        var date;
        var room_id;

        $(".btn-group :checked").each(function() {
            hours.push(this.id.substring(10));
        });
        //console.log({'h':hours.toString()});
        //room_id = $("#main_form").name
        console.log('room: ' + room_id)
        date = this.id.substring(7,17)
        room_id = this.id.substring(17)
        console.log('id: ' + this.id)
        console.log('hours: ' + hours)
        console.log('date: ' + date)

        console.log('dla detail: ' + csrftoken);
        var jqxhr = $.ajax(
                room_id + "/make_reservation",
                //"make_reservation",
                {
                type: "POST",
                //data: {'hours': '['+hours.toString()+']', 'room_id': room_id, 'date': my_date }
                data: {'hours': hours, 'room_id': room_id, 'date': date,
                'csrfmiddlewaretoken': csrftoken}

        })
        .done(function(data) {
            console.log( "success" );
            $("#modalContent").html(data);
            count = 0;
            })
        .fail(function() {
            console.log( "error" );
            alert("We are sorry but i is impossible to make the reservation you wanted.")
            })
        .always(function() {
            console.log( "complete" );
            });

})



//TODO: pozbyc sie wszytskich statycznych elementow

</script>





</body>
</html>




