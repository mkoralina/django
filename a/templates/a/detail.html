<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!--ajax-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">


    {% load staticfiles %}
    <link href="{% static 'bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" media="screen">
    <style type="text/css">
        <!-- -->
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    {% load staticfiles %}
    <script src="{% static 'bootstrap/js/bootstrap.min.js' %}"></script>




    <title>{% block title %}Choose your term</title>{% endblock%}

</head>
<body>

    <h1>{{ room.name }}</h1>

    {% if error_message %}
        <p>{{ error_message }}</p>
    {% else %}


    <div id="chosenCounter">
        You have chosen {{ counter }} hour(s) so far<br><br>
    </div>

    {% if room.terms.all %}

        {% regroup room.terms.all by date as terms_list %}

        <form id="main_form" action="{% url 'a:make_reservation' room.id %}" method="post" name="{{room.id}}">
        {% csrf_token %}

        {% for date in terms_list %}

        {% with forloop.counter|stringformat:"s" as id %}
        {% with "collapse"|add:id as collapse_id %}
        {% with "#collapse"|add:id as href_collapse %}



        <div class="panel-group" id="accordion{{ forloop.counter }}">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion{{ forloop.counter }}" href="#collapse{{ forloop.counter }}" >

                    Date: {{ date.grouper }}
                    (
                        {% for item in date.list %}
                            {{item.begin_time.hour}} - {{item.end_time.hour}},
                        {% endfor %}
                    )

                    </a>
                    </h4>
                </div>
                <div id="collapse{{ forloop.counter }}" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="btn-group" data-toggle="buttons">

                            Choose from available hours and click on Reserve: <br><br>
                            {% for item in date.list %}
                                {% for hour in item.hours %}

                                <label class="btn btn-primary btn-hour">
                                <input type="checkbox" name="checkboxes[]" id="{{item.date}}{{ hour }}" value="{{ item.date }}"> {{ hour }} - {{ hour|add:"1" }}
                                </label>


                                {% endfor %}

                            {% endfor %}

                        </div>
                    <br><br>
                    <p id="demo1"></p>
                    <input id="{{ item.date}}" class="btn btn-large btn-reserve" value="Reserve">
                    </div>
                </div>
            </div>
        </div>

        {% endwith %}
        {% endwith %}
        {% endwith %}

        {% endfor %}

        </form>

        {% else %}

        There are no terms available.

        {% endif %}

        <hr>
        {% if user.is_authenticated %}
            <p>You are logged in as: {{ user.username }}<br>
                <a href="{% url 'a:logout' %}">Log out</a></p>
        {% endif %}


    {% endif %}


<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

var csrftoken = getCookie('csrftoken');

var count = 0;

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

function sameOrigin(url) {
    // test that a given url is a same-origin URL
    // url could be relative or scheme relative or absolute
    var host = document.location.host; // host + port
    var protocol = document.location.protocol;
    var sr_origin = '//' + host;
    var origin = protocol + sr_origin;
    // Allow absolute or scheme relative URLs to same origin
    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
        // or any other URL that isn't scheme relative or absolute i.e relative.
        !(/^(\/\/|http:|https:).*/.test(url));
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
            // Send the token to same-origin, relative URLs only.
            // Send the token only if the method warrants CSRF protection
            // Using the CSRFToken value acquired earlier
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

$(".btn-group :checkbox").change(function() {

    if (this.checked) {
        count += 1;
    }
    else {
        count -= 1;
    }
    $("#chosenCounter").html("You have chosen " + count + " hour(s) so far <br><br>");


});

$(".btn-reserve").click(function(e) {
        e.preventDefault();
        var hours = [];
        var my_date;

        $(".btn-group :checked").each(function() {
            hours.push(this.id);
            console.log(this.id);
            //room_id = this.name;
        });
        console.log({'h':hours.toString()});
        //hours = JSON.stringify(hours)
        room_id = $("#main_form").name
        //alert(room_id);
        my_date = this.id

        //hours_2 = $("#" + room_id).serializeArray()

        document.getElementById("demo1").innerHTML = hours;

        return false;

        console.log(csrftoken);
        var jqxhr = $.ajax(
                //room_id + "/make_reservation",
                "make_reservation",
                {
                type: "POST",
                //data: {'hours': '['+hours.toString()+']', 'room_id': room_id, 'date': my_date }
                data: {'hours': hours, 'room_id': room_id, 'date': my_date }
        })
        .done(function(data) {
            console.log( "success" );
            $("#modalContent").html(data);
            count = 0;
            })
        .fail(function() {
            console.log( "error" );
            alert("We are sorry but the room you have chosen is no longer available in the desirable time")
            })
        .always(function() {
            console.log( "complete" );
            });

        });


</script>

</body>
</html>

